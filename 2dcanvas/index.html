<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title></title>
		<style>
canvas {
	z-index: 2;
	position: relative;
	border: 1px solid black;
	cursor: crosshair;
}

canvas:active, canvas:focus {
	cursor: move;
}

#canvases > canvas {
	position: absolute;
	top: 0;
	left: 0;
}

#canvases, #canvases > canvas {
	height: 200px;
	width: 200px;
}

#crosshair {
	opacity: 0.1;
}

#canvases {
	position: relative;
}

.canvas-filter {
	z-index: 1;
	height: 100%;
	width: 100%;
	position: absolute;
	top: 0;
	left: 0;
	cursor: move;
}
		</style>
		<script src="jquery-1.7.2.min.js"></script>
		<script src="heatmap.js"></script>
		<script>

function generateHeatmap() {
	var o = h337.create({element: $("#canvases")[0], radius: 15, visible: true});
	//o.store.generateRandomDataSet(20);
	o.get('canvas').style.zIndex = 0;
	return o;
}

function createCrossSection(node, notchSpacing) {
	var ctx = node.getContext('2d'),
		height = node.height,
		width = node.width,
		origin = [node.width/2, node.height/2],
		notchWidth = 10,
		i, j, start, end;
			
	notchSpacing || (notchSpacing = 10);
	if (notchSpacing < 1) {
		throw new Error("notch spacing must be greater than 0");
	}

	ctx.beginPath();
	
	// vertical line
	ctx.moveTo(width / 2, 0);
	ctx.lineTo(width / 2, height);
	
	// horizontal line
	ctx.moveTo(0, height / 2);
	ctx.lineTo(width, height / 2);

	// notches
	i = j = origin[0];
	start = origin[1] - notchWidth / 2;
	end = origin[1] + notchWidth / 2;
	while (i <= width) {
		ctx.moveTo(i, start);
		ctx.lineTo(i, end);
		ctx.moveTo(j, start);
		ctx.lineTo(j, end);
		i += notchSpacing;
		j -= notchSpacing;
	}

	i = j = origin[1];
	start = origin[0] - notchWidth / 2;
	end = origin[0] + notchWidth / 2;
	while (i <= height) {
		ctx.moveTo(start, i);
		ctx.lineTo(end, i);
		ctx.moveTo(start, j);
		ctx.lineTo(end, j);
		i += notchSpacing;
		j -= notchSpacing;
	}

	ctx.stroke();
}

function placeDot(e, dotSize) {
	e.preventDefault();
	dotSize || (dotSize = 10);

	var ctx = this.getContext('2d'),
		mPos = h337.util.mousePosition(e),
		x = mPos[0], y = mPos[1],
		saneX = Math.max(0, Math.min(x, this.width)),
		saneY = Math.max(0, Math.min(y, this.height));
		
	ctx.clearRect(0, 0, this.width, this.height);
	ctx.beginPath();
	ctx.moveTo(saneX-dotSize, saneY);
	ctx.lineTo(saneX+dotSize, saneY);
	ctx.moveTo(saneX, saneY-dotSize);
	ctx.lineTo(saneX, saneY+dotSize);
	ctx.stroke();

	$("#info").html("x: " + saneX + ", y: " + saneY);
}


$(function() {
	var mouseState = false;
	var canvas = $('#user')[0];
	var heatmap = generateHeatmap();

	createCrossSection($("#crosshair")[0]);

	$(canvas).on('mousedown', function(e) {
		$("<div class='canvas-filter'></div>").appendTo($('body'));
		mouseState = true;
		placeDot.call(canvas, e);
		var pos = h337.util.mousePosition(e);
		heatmap.store.addDataPoint(pos[0], pos[1]);
	});
	
	$(window).on('mouseup', function(e) {
		if (mouseState) {
			mouseState = false;
			$(".canvas-filter").remove();
			$('body').css('cursor', '');
		}
	}).on('mousemove', function(e) {
		if (!mouseState) { 
			return;
		}
		$('body').css('cursor', 'move');
		placeDot.call(canvas, e);
		//var pos = h337.util.mousePosition(e);
		//heatmap.store.addDataPoint(pos[0], pos[1]);
	});
});
		</script>
	</head>
	<body>
		<div id='canvases'>
			<canvas id='crosshair' height='200' width='200'></canvas>
			<canvas id='user' height="200" width="200"></canvas>
		</div>
		<div id='info'></div>
	</body>
</html>
