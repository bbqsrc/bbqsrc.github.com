<!DOCTYPE html>
<html data-ng-app>
  <head>
    <title>Angular Table Example</title>
    <meta charset="utf-8">
    <style>
      html, body {
        font-family: sans-serif;
      }

      table {
        border: 1px solid red;
      }

      tfoot {
        text-align: right;
      }

      input[type='number'] {
        text-align: right;
        box-sizing: border-box;
        width: 100%;
      }

      input[readonly] {
        border-color: transparent;
      }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js"></script>
    <script>
    function TableController($scope) {
      $scope.solutions = ["First", "Second", "Third", "Herp"];
      $scope.criteria = ["Criteria 1", "Criteria 2", "Criteria 3", "Criteria 4", "Criteria 5"];
      $scope.rows = [];
      $scope.weights = [];

      $scope.writable = true;

      {
        var column, i, ii, cells,
            w = 100 / $scope.criteria.length;

        cells = function() {
          var x = [];
          for (var i = 0, ii = $scope.solutions.length; i < ii; ++i) {
            x.push({name: $scope.solutions[i], value: 0});
          }
          return x;
        };

        for (i = 0, ii = $scope.criteria.length; i < ii; ++i) {
          $scope.rows.push({
            name: $scope.criteria[i],
            weight: w,
            lastWeight: w,
            isPegged: false, 
            cells: cells()
          });
        }
      }

      $scope.toggleWritable = function() {
        $scope.writable = !$scope.writable;
      }

      $scope.getMax = function(comp) {
        return (comp + $scope.remainingScore > $scope.remainingScore ? comp : 0) + $scope.remainingScore;
      }
      
      /*
      $scope.weightMeBro = function() {
        this.row.weight = parseInt(this.row.weight, 10);
        this.row.lastWeight = parseInt(this.row.lastWeight, 10) || this.row.weight;

        var split = $scope.criteria.length - 1,
            diff = (this.row.lastWeight - this.row.weight) * 100 / split / 100;
        this.row.lastWeight = this.row.weight;
        
        for (var i = 0, ii = $scope.rows.length; i < ii; ++i) {
          if ($scope.rows[i] != this.row) {
            console.log($scope.rows[i]);
            $scope.rows[i].weight += diff;
          }
        }
      }
      */

      $scope.gimmeMahTotalBro = function() {
        var out = 0;
        for (var i = 0, ii = $scope.rows.length; i < ii; ++i) {
          for (var j = 0, jj = $scope.rows[i].cells.length; j < jj; ++j) {
            if ($scope.rows[i].cells[j].name == this.col) {
              out += $scope.rows[i].cells[j].value * $scope.rows[i].weight;
            }
          }
        }
        return out;
      }

      $scope.normaliseWeights = function() {
        var weight = parseFloat(this.row.weight),
            lastWeight = parseFloat(this.row.lastWeight),
            split = $scope.criteria.length - 1,
            diff, offset = 0, i, ii, c = 0;
        
        // ensure they aren't strings, ever
        this.row.weight = weight;
        this.row.lastWeight = lastWeight;

        // Ignore pegged
        for (i = 0, ii = $scope.rows.length; i < ii; ++i) {
          if ($scope.rows[i] != this.row && $scope.rows[i].isPegged) {
            split -= 1;
          }
        }

        // Check for potential for all pegged and no movement possible
        if (split == 0) {
          this.row.weight = lastWeight;
          return;
        }

        // Find all the ones too close to zero to fairly distribute
        diff = (lastWeight - weight) * 100 / split / 100;
        console.log(lastWeight, weight, diff);
        for (i = 0, ii = $scope.rows.length; i < ii; ++i) {
          
          if ($scope.rows[i] != this.row && !$scope.rows[i].isPegged) {
            if ($scope.rows[i].weight + diff < 0) {
              console.log("<0 - " + $scope.rows[i].weight + " - " + diff);
              offset += diff; //$scope.rows[i].weight;
              $scope.rows[i].weight = $scope.rows[i].lastWeight = 0;
            }
          }
        }
        diff += offset;

        console.log("diff: " + diff);
        // Now split the ones who are left with the adjusted value
        for (i = 0, ii = $scope.rows.length; i < ii; ++i) {
          if ($scope.rows[i] != this.row && !$scope.rows[i].isPegged && $scope.rows[i].weight + diff >= 0 && $scope.rows[i].weight + diff <= 100) {
            $scope.rows[i].weight += diff;
            $scope.rows[i].lastWeight = $scope.rows[i].weight;
          }
        }

        // Check that we didn't over or underflow
        for (i = 0, ii = $scope.rows.length; i < ii; ++i) {
          c += $scope.rows[i].weight;
        }

        if (c != 100) {
          console.log(c);
          this.row.weight = weight = lastWeight;
        }
        this.row.lastWeight = weight;
      }
    }
    </script>
  </head>
  <body>
    <h2>Table Example</h2>
    <div id="table" data-ng-controller="TableController">
      <table>
        <thead>
          <tr>
            <td colspan='2'></td>
            <th data-ng-repeat="header in solutions">{{header}}</th>
          </tr>
        </thead>
        <tbody>
          <tr data-ng-repeat="row in rows">
            <th>{{row.name}}</th>
            <td style="border-right: 1px dotted black">
              <input type='checkbox' data-ng-model='row.isPegged'>
              <input data-ng-disabled="!writable || row.isPegged"
              type="range" min="0" max="100" data-ng-model="row.weight"
              data-ng-change="normaliseWeights()">
              <input data-ng-readonly="!writable || row.isPegged"
              type="number" min="0" max="100" data-ng-model="row.weight"
              data-ng-change="normaliseWeights()">
            </td>
            <td data-ng-repeat="cell in row.cells">
              <input data-ng-readonly="!writable" type="number" min="0" max="10" 
              step="1" data-ng-model="cell.value">
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="2">Total:</td>
            <td data-ng-repeat="col in solutions">{{gimmeMahTotalBro()}}</td>
          </tr>
        </tfoot>
      </table>
      <button data-ng-click="toggleWritable()">Toggle Readonly</button><br>
      <textarea>{{rows}}</textarea>
    </div>
  </body>
</html>

