<!DOCTYPE html>
<html data-ng-app>
  <head>
    <title>Angular Table Example</title>
    <meta charset="utf-8">
    <style>
      html, body {
        font-family: sans-serif;
      }

      table {
        border: 1px solid red;
      }

      tfoot {
        text-align: right;
      }
      
      .dashed-right {
        border-right: 1px dashed black;
      }

      [id*='row'], [for*='row'] {
        cursor: pointer;
      }

      td {
        padding: 0.3em;
      }

      input[type='number'] {
        text-align: right;
        box-sizing: border-box;
        width: 100%;
      }

      input[readonly] {
        border-color: transparent;
      }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js"></script>
    <script>
    function TableController($scope) {
      $scope.root = $scope; // Hack to reveal root scope to repeats
      
      $scope.solutions = ["First", "Second", "Third", "Herp"];
      $scope.criteria = ["Criteria 1", "Criteria 2", "Criteria 3", "Criteria 4", "Criteria 5"];
      $scope.rows = [];
      $scope.weights = [];

      $scope.writable = true;
      $scope.selectedRow = 0;

      {
        var column, i, ii, cells,
            w = 5;//100 / $scope.criteria.length;

        cells = function() {
          var x = [];
          for (var i = 0, ii = $scope.solutions.length; i < ii; ++i) {
            x.push({name: $scope.solutions[i], value: 0});
          }
          return x;
        };

        for (i = 0, ii = $scope.criteria.length; i < ii; ++i) {
          $scope.rows.push({
            name: $scope.criteria[i],
            weight: w,
            lastWeight: w,
            isPegged: false, 
            cells: cells()
          });
        }
      }

      $scope.toggleWritable = function() {
        $scope.writable = !$scope.writable;
      }

      $scope.getMax = function(comp) {
        return (comp + $scope.remainingScore > $scope.remainingScore ? comp : 0) + $scope.remainingScore;
      }
      
      $scope.getMaxWeight = function() {
        return 5 * $scope.criteria.length;
      }

      $scope.columnTotal = function() {
        var out = 0;
        for (var i = 0, ii = $scope.rows.length; i < ii; ++i) {
          for (var j = 0, jj = $scope.rows[i].cells.length; j < jj; ++j) {
            if ($scope.rows[i].cells[j].name == this.col) {
              out += $scope.rows[i].cells[j].value * $scope.rows[i].weight;
            }
          }
        }
        return out;
      }
      
      $scope.swapWeight = function() {
        var weight = parseInt(this.row.weight, 10),
            //lastWeight = parseInt(this.row.lastWeight, 10),
            otherRow = $scope.rows[$scope.selectedRow],
            diff, offset = 0, i, ii, c = 0;

        // Normalise weight
        if (!isFinite(weight) || weight < 0) {
          this.row.weight = weight = 0;
        } else if (weight > $scope.getMaxWeight()) {
          this.row.weight = weight = $scope.getMaxWeight();
        }

        // Count all of the things!
        for (i = 0, ii = $scope.rows.length; i < ii; ++i) {
          c += $scope.rows[i].weight;
        }
        diff = $scope.getMaxWeight() - c;

        // Find all the ones too close to zero to fairly distribute
        console.log(c, weight, diff);

        // Bail out if other row is unselected somehow
        if (otherRow == null) {
          this.row.weight += $scope.getMaxWeight() - c;
          return;
        } else if (otherRow.weight + diff < 0) {
          otherRow.weight = 0;
        } else {
          otherRow.weight += diff;
        }

        // Check that we didn't over or underflow
        c = 0;
        for (i = 0, ii = $scope.rows.length; i < ii; ++i) {
          c += $scope.rows[i].weight;
        }

        if (c != $scope.getMaxWeight()) {
          console.log("!= $scope.getMaxWeight(): " + c);
          this.row.weight += $scope.getMaxWeight() - c;
        }
      }

      $scope.readOnlyCheck = function() {
        return !$scope.writable || $scope.rows.indexOf(this.row) == parseInt($scope.selectedRow, 10);
      }
    }
    </script>
  </head>
  <body data-ng-app="maut" data-ng-init="">
    <h2>Table Example</h2>
    <div id="table" data-ng-controller="TableController">
      <table>
        <thead>
          <tr>
            <td colspan='4' style='color: gray' class='dashed-right'><small>Sliders are disabled due to a bug.</small></td>
            <th data-ng-repeat="header in solutions">{{header}}</th>
          </tr>
        </thead>
        <tbody>
          <tr data-ng-repeat="row in rows">
            <td>
              <input type='radio' name='row' id='row-{{rows.indexOf(row)}}' value='{{rows.indexOf(row)}}' 
              data-ng-model="root.selectedRow" data-ng-change="parseInt(root.selectedRow,10)">
            </td>
            <th>
              <label for="row-{{rows.indexOf(row)}}">{{row.name}}</label>
            </th>
            <td>
              <input data-ng-disabled="true || readOnlyCheck()"
              type="range" min="0" max="{{getMaxWeight()}}" data-ng-model="row.weight"
              data-ng-change="swapWeight()">
            </td>
            <td class='dashed-right'>
              <input data-ng-readonly="readOnlyCheck()"
              type="number" min="0" max="{{getMaxWeight()}}" data-ng-model="row.weight"
              data-ng-change="swapWeight()">
            </td>
            <td data-ng-repeat="cell in row.cells">
              <input data-ng-readonly="!writable" type="number" min="0" max="10" 
              step="1" data-ng-model="cell.value">
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4" class='dashed-right'>Total</td>
            <td data-ng-repeat="col in solutions">{{columnTotal()}}</td>
          </tr>
        </tfoot>
      </table>
      <div>
        <label><small>Debug</small> Rows data:<br>
          <textarea readonly style="min-width: 550px; min-height: 200px">{{rows}}</textarea>
        </label><br>
        <label><small>Debug</small> Selected criterion: 
          <input style="width: 50px" type='text' data-ng-model="selectedRow">
        </label><br>
        <button data-ng-click="toggleWritable()">Toggle Readonly</button><br>
      </div>  
    </div>
  </body>
</html>

